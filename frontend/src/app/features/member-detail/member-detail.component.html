<div class="container py-4" *ngIf="member">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="m-0">{{ member.name }}</h2>
    <button mat-stroked-button color="primary" (click)="openEdit()">Edit / Renew</button>
  </div>
  <mat-tab-group>
    <mat-tab label="Overview">
      <div class="row g-3 mt-2">
        <div class="col-md-6">
          <h5 class="mb-2">Membership</h5>
          <table mat-table [dataSource]="membershipRows" class="w-100 mat-elevation-z1">

            <ng-container matColumnDef="label">
              <th mat-header-cell *matHeaderCellDef>Label</th>
              <td mat-cell *matCellDef="let r">{{ r.label }}</td>
            </ng-container>

            <ng-container matColumnDef="value">
              <th mat-header-cell *matHeaderCellDef>Value</th>
              <td mat-cell *matCellDef="let r">{{ r.value }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['label','value']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['label','value'];"></tr>
          </table>
        </div>
      </div>
    </mat-tab>
    <mat-tab label="Payments">
      <div class="d-flex justify-content-end mt-2">
        <button mat-raised-button color="warn" (click)="addPayment()">Add Payment</button>
      </div>
      <div class="mt-3">
        <table mat-table [dataSource]="payments" class="w-100 mat-elevation-z1" *ngIf="payments && payments.length; else noPayments">
          <ng-container matColumnDef="paidOn">
            <th mat-header-cell *matHeaderCellDef>Date</th>
            <td mat-cell *matCellDef="let p">{{ p.paidOn }}</td>
          </ng-container>
          <ng-container matColumnDef="amount">
            <th mat-header-cell *matHeaderCellDef>Amount</th>
            <td mat-cell *matCellDef="let p">{{ p.amount }}</td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="['paidOn','amount']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['paidOn','amount'];"></tr>
        </table>
        <ng-template #noPayments>
          <div class="alert alert-info">No data found</div>
        </ng-template>
      </div>
    </mat-tab>
    <mat-tab label="Check-ins">
      <div class="d-flex justify-content-end mt-2">
        <button mat-raised-button color="primary" (click)="checkIn()">Check-in</button>
        <button mat-raised-button color="accent" class="ms-2" (click)="checkOut()">Check-out</button>
      </div>
      <div class="mt-3">
        <table mat-table [dataSource]="checkins" class="w-100 mat-elevation-z1" *ngIf="checkins && checkins.length; else noCheckins">
          <ng-container matColumnDef="checkinAt">
            <th mat-header-cell *matHeaderCellDef>In</th>
            <td mat-cell *matCellDef="let c">{{ c.checkinAt | date:'d MMMM y h:mm:ssa' | lowercase }}</td>
          </ng-container>
          <ng-container matColumnDef="checkoutAt">
            <th mat-header-cell *matHeaderCellDef>Out</th>
            <td mat-cell *matCellDef="let c">{{ c.checkoutAt ? ((c.checkoutAt | date:'d MMMM y h:mm:ssa') | lowercase) : '-' }}</td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="['checkinAt','checkoutAt']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['checkinAt','checkoutAt'];"></tr>
        </table>
        <ng-template #noCheckins>
          <div class="alert alert-info">No data found</div>
        </ng-template>
      </div>
    </mat-tab>
    <mat-tab label="Plan Switch History">
      <div class="mt-3">
        <div class="row">
          <div class="col-12">
            <h5>Membership Plan Changes</h5>
            <div class="mb-3">
              <small class="text-muted">Track all plan changes and renewals for this member</small>
            </div>
          </div>
        </div>

        <!-- Plan Change History -->
        <div class="card mb-4" *ngIf="planHistory && planHistory.length">
          <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Plan Change Log</h6>
          </div>
          <div class="card-body">
            <div class="timeline">
              <div class="timeline-item" *ngFor="let change of planHistory">
                <div class="timeline-marker">
                  <i class="fas fa-arrow-right text-primary"></i>
                </div>
                <div class="timeline-content">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h6 class="mb-1">
                        <span class="badge bg-secondary me-2">{{ change.fromPlan?.name || 'Initial' }}</span>
                        <i class="fas fa-arrow-right mx-2"></i>
                        <span class="badge bg-primary">{{ change.toPlan?.name }}</span>
                      </h6>
                      <p class="mb-0 text-muted small">{{ change.changedAt | date:'d MMMM y, h:mm a' }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Membership Periods Timeline -->
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Membership Periods & Transactions</h6>
          </div>
          <div class="card-body">
            <div class="accordion" id="periodsAccordion" *ngIf="membershipPeriods && membershipPeriods.length">
              <div class="accordion-item" *ngFor="let period of membershipPeriods; let i = index">
                <h2 class="accordion-header" [id]="'heading' + i">
                  <button class="accordion-button" [class.collapsed]="i !== 0" type="button" 
                          data-bs-toggle="collapse" [attr.data-bs-target]="'#collapse' + i" 
                          [attr.aria-expanded]="i === 0" [attr.aria-controls]="'collapse' + i">
                    <div class="d-flex justify-content-between w-100 me-3">
                      <div>
                        <strong>{{ period.membershipPlan.name }}</strong>
                        <span class="badge ms-2" 
                              [class.bg-success]="period.periodType === 'initial'"
                              [class.bg-info]="period.periodType === 'renewal'"
                              [class.bg-warning]="period.periodType === 'plan_switch'">
                          {{ period.periodType | titlecase }}
                        </span>
                      </div>
                      <div class="text-end">
                        <small class="text-muted">{{ period.startDate }} to {{ period.endDate }}</small>
                        <br>
                        <span class="badge" 
                              [class.bg-success]="period.status === 'active'"
                              [class.bg-secondary]="period.status === 'completed'"
                              [class.bg-danger]="period.status === 'cancelled'">
                          {{ period.status | titlecase }}
                        </span>
                      </div>
                    </div>
                  </button>
                </h2>
                <div [id]="'collapse' + i" class="accordion-collapse collapse" 
                     [class.show]="i === 0" [attr.aria-labelledby]="'heading' + i" 
                     data-bs-parent="#periodsAccordion">
                  <div class="accordion-body">
                    <div class="row">
                      <div class="col-md-6">
                        <h6>Financial Summary</h6>
                        <table class="table table-sm">
                          <tr>
                            <td><strong>Plan Fees:</strong></td>
                            <td>₹{{ period.planFees }}</td>
                          </tr>
                          <tr>
                            <td><strong>Fees Paid:</strong></td>
                            <td class="text-success">₹{{ period.feesPaid }}</td>
                          </tr>
                          <tr>
                            <td><strong>Due Amount:</strong></td>
                            <td [class.text-danger]="period.dueAmount > 0" [class.text-success]="period.dueAmount === 0">
                              ₹{{ period.dueAmount }}
                            </td>
                          </tr>
                        </table>
                      </div>
                      <div class="col-md-6">
                        <h6>Period Information</h6>
                        <table class="table table-sm">
                          <tr>
                            <td><strong>Start Date:</strong></td>
                            <td>{{ period.startDate | date:'d MMM y' }}</td>
                          </tr>
                          <tr>
                            <td><strong>End Date:</strong></td>
                            <td>{{ period.endDate | date:'d MMM y' }}</td>
                          </tr>
                          <tr>
                            <td><strong>Duration:</strong></td>
                            <td>{{ getDuration(period.startDate, period.endDate) }} days</td>
                          </tr>
                        </table>
                      </div>
                    </div>

                    <hr>
                    
                    <h6>Payments for this Period</h6>
                    <table mat-table [dataSource]="period.payments" class="w-100 mat-elevation-z1" 
                           *ngIf="period.payments && period.payments.length; else noPeriodPayments">
                      <ng-container matColumnDef="paidOn">
                        <th mat-header-cell *matHeaderCellDef>Date</th>
                        <td mat-cell *matCellDef="let p">{{ p.paidOn | date:'d MMM y' }}</td>
                      </ng-container>
                      <ng-container matColumnDef="amount">
                        <th mat-header-cell *matHeaderCellDef>Amount</th>
                        <td mat-cell *matCellDef="let p">₹{{ p.amount }}</td>
                      </ng-container>
                      <ng-container matColumnDef="method">
                        <th mat-header-cell *matHeaderCellDef>Method</th>
                        <td mat-cell *matCellDef="let p">
                          <span class="badge" 
                                [class.bg-success]="p.method === 'cash'"
                                [class.bg-info]="p.method === 'digital'">
                            {{ p.method | titlecase }}
                          </span>
                        </td>
                      </ng-container>
                      <tr mat-header-row *matHeaderRowDef="['paidOn','amount','method']"></tr>
                      <tr mat-row *matRowDef="let row; columns: ['paidOn','amount','method'];"></tr>
                    </table>
                    <ng-template #noPeriodPayments>
                      <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>No payments recorded for this period
                      </div>
                    </ng-template>
                  </div>
                </div>
              </div>
            </div>

            <!-- No periods message -->
            <div class="alert alert-info" *ngIf="!membershipPeriods || membershipPeriods.length === 0">
              <i class="fas fa-info-circle me-2"></i>No membership periods found
            </div>
          </div>
        </div>

        <!-- No plan history message -->
        <div class="alert alert-info" *ngIf="!planHistory || planHistory.length === 0">
          <i class="fas fa-info-circle me-2"></i>No plan changes recorded yet
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
